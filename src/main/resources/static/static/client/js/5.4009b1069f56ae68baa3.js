webpackJsonp([5],{"/AGb":function(t,e,n){"use strict";var s=n("vLgD"),a=n("X2Oc"),i={name:"selectTpl",mixins:[n("RAp7").a],data:function(){return{noTime:!0,total:0,lists:[],pageSizes:[10,30,50,100],listQuery:{page:1,limit:10,offset:0,tplStatus:1,starttime:"",endtime:""},dialogTpl:!1,dialogTplType:1,form:{id:"",tplContent:""},smsContent:{signature:"",content:""},num:1,smsTplLength:0}},created:function(){this.getList()},methods:{useTpl:function(t){this.$emit("useTpl",t)},getList:function(t){var e=this;t&&(e.listQuery.page=1,e.listQuery.offset=0),e.listQuery.offset=(e.listQuery.page-1)*e.listQuery.limit,Object(s.a)("sms/custom/template/list",e.listQuery).then(function(t){e.lists=t.rows,e.total=t.total}).catch(function(){})},submitTpl:function(){var t=this,e=t.smsContent;if(e.signature)if(e.content){t.form.tplContent="【"+e.signature+"】"+e.content;var n=2===t.dialogTplType?"sms/custom/template/update":"sms/custom/template/save";Object(s.b)(n,t.form).then(function(e){t.getList(1),t.dialogTpl=!1}).catch(function(){})}else t.R("短信内容不能为空！");else t.R("签名不能为空！")},addTpl:function(){var t=this;t.smsContent.signature="",t.smsContent.content="",t.form.tplContent="",t.dialogTplType=1,t.dialogTpl=!0},addVar:function(){var t=this;t.smsContent.content=t.smsContent.content+"${变量"+t.num+"}",t.num=t.num+1},inputWitdh:function(){var t=$(".sms-select-tpl .sms-content p").width();$(".sms-select-tpl .sms-content input").width(t+2);var e=t+40;e=e>68?e:68,$(".sms-select-tpl .sms-content textarea").css({"text-indent":e})},tplLenght:function(){var t=this.smsContent,e="【"+t.signature+"】"+t.content;return this.smsTplLength=e.length,e.length}},watch:{"smsContent.signature":function(t,e){var n=this;n.$nextTick(function(){n.inputWitdh(),n.tplLenght()>500&&(n.smsContent.signature=e)})},"smsContent.content":function(t,e){var n=this,s=t.match(/^【(.+?)】/g);if(s&&1===s.length&&s[0].length<25){var i=t.replace(s[0],"");n.smsContent.signature=s[0].replace("【","").replace("】",""),n.smsContent.content=i}var o=new RegExp(/\${(.+?)}/g),l=t.match(o);Object(a.m)(l)&&(n.R("变量名称不能重复!"),n.smsContent.content=e),n.$nextTick(function(){n.inputWitdh(),n.tplLenght()>500&&(n.smsContent.content=e)})}}},o={render:function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"sms-select-tpl"},[n("div",[n("el-button",{attrs:{type:"primary",size:"small"},on:{click:function(e){return t.addTpl()}}},[t._v("新增模板")])],1),t._v(" "),n("el-table",{attrs:{data:t.lists}},[n("el-table-column",{attrs:{label:"模板ID",prop:"id",width:"100"}}),t._v(" "),n("el-table-column",{attrs:{label:"模板内容",prop:"tplContent","min-width":"300px","show-overflow-tooltip":!0}}),t._v(" "),n("el-table-column",{attrs:{label:"提交时间",prop:"createTime","min-width":"170"}}),t._v(" "),n("el-table-column",{attrs:{align:"center",label:"审核状态"},scopedSlots:t._u([{key:"default",fn:function(e){return[0==e.row.tplStatus?n("p",{staticClass:"td-btn"},[n("font",{staticClass:"point point-error"},[t._v("未通过")])],1):t._e(),t._v(" "),1==e.row.tplStatus?n("p",{staticClass:"td-btn"},[n("font",{staticClass:"point point-success"},[t._v("已通过")])],1):t._e(),t._v(" "),2==e.row.tplStatus?n("p",{staticClass:"td-btn"},[n("font",{staticClass:"point point-warning"},[t._v("待审核")])],1):t._e(),t._v(" "),4==e.row.tplStatus?n("p",{staticClass:"td-btn"},[n("font",{staticClass:"point point-warning"},[t._v("审核中")])],1):t._e()]}}])}),t._v(" "),n("el-table-column",{attrs:{align:"center",fixed:"right",label:"操作",width:"80"},scopedSlots:t._u([{key:"default",fn:function(e){return[n("p",{staticClass:"operating"},[n("a",{on:{click:function(n){return t.useTpl(e.row)}}},[t._v("使用")])])]}}])})],1),t._v(" "),n("div",{staticClass:"pagination-container"},[n("el-pagination",{attrs:{"current-page":t.listQuery.page,"page-size":t.listQuery.limit,"page-sizes":t.pageSizes,total:t.total,background:"",layout:"total, prev, pager, next, sizes, jumper"},on:{"current-change":t.handleCurrentChange,"size-change":t.handleSizeChange}})],1),t._v(" "),n("transition",{attrs:{name:"dialog-fade"}},[n("div",{directives:[{name:"show",rawName:"v-show",value:t.dialogTpl,expression:"dialogTpl"}],staticClass:"dialog dialog-min"},[n("div",{staticClass:"dialog-body"},[n("div",{staticClass:"dialog-header"},[1==t.dialogTplType?n("span",[t._v("新增模板")]):t._e(),t._v(" "),2==t.dialogTplType?n("span",[t._v("编辑模板")]):t._e(),t._v(" "),n("i",{staticClass:"fr iconfont iconsystem-cancel-bold",on:{click:function(e){t.dialogTpl=!1}}})]),t._v(" "),n("div",{staticClass:"dialog-content p2"},[n("div",{staticClass:"alert",staticStyle:{"margin-bottom":"20px"}},[n("i",{staticClass:"el-icon-warning color"}),t._v(" "),n("p",[n("b",[t._v("帮助提示")]),n("br"),t._v("\n              1、定制短信模板由签名和内容组成，签名通常为企业名称简称或品牌名称；"),n("br"),t._v("\n              2、定制短信通常包含变量，变量请用 ${变量名称} 占位；"),n("br"),t._v("\n              3、变量名称不能重复。\n              4、定制短信一条为70个字符，超过70字符为长短信，长短信计费为每条67个字符。\n            ")])]),t._v(" "),n("el-form",{staticStyle:{width:"520px",margin:"0 auto"},attrs:{"label-position":"right","label-width":"100px"}},[t.form.id?n("div",{staticClass:"el-form-item"},[n("label",{staticClass:"el-form-item__label",staticStyle:{width:"100px"}},[t._v("模板ID：")]),t._v(" "),n("div",{staticClass:"el-form-item__content info",staticStyle:{"margin-left":"100px"}},[t._v(t._s(t.form.id))])]):t._e(),t._v(" "),n("div",{staticClass:"el-form-item is-required"},[n("label",{staticClass:"el-form-item__label",staticStyle:{width:"100px"}},[t._v("模板内容：")]),t._v(" "),n("div",{staticClass:"el-form-item__content",staticStyle:{"margin-left":"100px"}},[n("div",{staticClass:"sms-content p1",staticStyle:{"margin-top":"12px"}},[n("p",[t._v(t._s(t.smsContent.signature||"短信签名，如：中国移动"))]),t._v(" "),n("div",{staticClass:"input"},[n("span",[t._v("【")]),t._v(" "),n("input",{directives:[{name:"model",rawName:"v-model.trim",value:t.smsContent.signature,expression:"smsContent.signature",modifiers:{trim:!0}}],attrs:{type:"text",maxlength:"24",placeholder:"短信签名，如：中国移动"},domProps:{value:t.smsContent.signature},on:{input:function(e){e.target.composing||t.$set(t.smsContent,"signature",e.target.value.trim())},blur:function(e){return t.$forceUpdate()}}}),t._v(" "),n("span",[t._v("】")])]),t._v(" "),n("textarea",{directives:[{name:"model",rawName:"v-model.trim",value:t.smsContent.content,expression:"smsContent.content",modifiers:{trim:!0}}],attrs:{rows:"8",placeholder:"短信内容，如：尊敬的${姓名}你好，您本月消费金额为:${金额}元，请注意查收账单！"},domProps:{value:t.smsContent.content},on:{input:function(e){e.target.composing||t.$set(t.smsContent,"content",e.target.value.trim())},blur:function(e){return t.$forceUpdate()}}}),t._v(" "),n("div",{staticClass:"t-r",staticStyle:{"margin-top":"10px"}},[n("span",{staticClass:"cp color",on:{click:function(e){return t.addVar()}}},[n("img",{staticStyle:{"vertical-align":"middle","margin-top":"-3px"},attrs:{src:"/static/client/img/sms/7.png"}}),t._v(" 添加变量")])])]),t._v(" "),n("div",{staticClass:"t-r info"},[t._v("\n                  "+t._s(t.smsTplLength)+"/500 字\n                ")])])])])],1),t._v(" "),n("div",{staticClass:"dialog-footer c p2"},[n("div",{staticClass:"fr"},[n("el-button",{attrs:{type:"primary"},on:{click:function(e){return t.submitTpl()}}},[t._v("确 认")]),t._v(" "),n("el-button",{on:{click:function(e){t.dialogTpl=!1}}},[t._v("取 消")])],1)])])])])],1)},staticRenderFns:[]},l=n("VU/8")(i,o,!1,null,null,null);e.a=l.exports},XKG4:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s=n("mvHQ"),a=n.n(s),i=n("0iPh"),o=n.n(i),l=(n("vLgD"),n("CKLt")),r=n("l6IN"),c=n("/AGb"),m=n("X2Oc"),u={inject:["reload"],name:"group_b",components:{"select-tpl":c.a},data:function(){return{customSentType:1,totalLength:0,smsLength:0,smsContent:{signature:"",content:""},fileName:"",dialogTpl:!1,previewLists:"",num:1,fileJson:"",fileErrJson:"",smsId:"",fullscreenLoading:!1}},created:function(){var t=new Date;t.setMinutes(t.getMinutes()+30),this.sentTime=t;var e=this.$route.params;e.id&&(this.smsContent.content=e.tplContent,this.smsId=e.id)},mounted:function(){var t=this;window.onbeforeunload=function(e){if(t.fullscreenLoading)return(e=e||window.event)&&(e.returnValue="数据正在提交中，您确认您要离开吗?"),"数据正在提交中，您确认您要离开吗?"}},methods:{sent:function(){var t=this,e={smsId:""},n=t.smsContent;if(n.signature)if(n.content){e.content="【"+n.signature+"】"+n.content,e.smsId=t.smsId;var s=t.fileJson.length;if(s<1)t.R("请导入模版文件！");else{for(var i=[],l=0;l<s;l++){var c={},m=t.fileJson[l];c.smsId=e.smsId,c.content=e.content,c.sendTime=m["发送时间"],delete m["发送时间"],c.info=a()([m]),i.push(c)}var u=r.Loading.service({customClass:"custom-submit-loading",background:"rgba(255,255,255,.8)",lock:!0,text:"数据正在提交中，请勿刷新您的浏览器或关闭此窗口。"});t.fullscreenLoading=!0,function e(n,a){a++,o.a.post("/custom/group/submit",n,function(n){0===n.code?a<s?e(i[a],a):(t.R(n.msg,"success"),u.close(),t.fullscreenLoading=!1,t.$router.push({path:"/client/custom/sent"})):500===n.code||1===n.code?(u.close(),t.fullscreenLoading=!1,t.R(n.msg)):(u.close(),t.fullscreenLoading=!1,t.R("抱歉，服务器出错了！"))}).fail(function(e){u.close(),t.fullscreenLoading=!1,t.R("系统错误，请稍后再试！")})}(i[0],0)}}else t.R("请输入短信内容或选择模板！！");else t.R("请输入短信签名或选择模板！")},importFile:function(t){var e=this,n=1===t?document.getElementById("file"):document.getElementById("file2");if(n.value){if(1===t){var s=e.smsContent.content;if(!s)return e.emptyVal(),void e.R("请输入内容或选择模板！")}var a=n.files[0].name,i=r.Loading.service();e.$nextTick(function(){Object(l.a)(n.files[0]).then(function(t){i.close(),e.reset(),e.fileName=a,e.emptyVal(),t.length>1e5?e.R("上传文件数据不要超过 100,000 条"):e.fileDataHandle(t,s)}).catch(function(t){e.emptyVal(),e.fileName="",i.close(),e.R(t)})})}},emptyVal:function(){document.getElementById("file").value=""},formatDateB:function(t){var e=Math.floor(t-25569),n=new Date(1e3*(86400*e)),s=t-Math.floor(t)+1e-7,a=Math.floor(86400*s),i=a%60;a-=i;var o=Math.floor(a/3600),l=Math.floor(a/60)%60,r=new Date(n.getFullYear(),n.getMonth(),n.getDate(),o,l,i);return Object(m.e)(r)},fileDataHandle:function(t,e){var n=this,s=new RegExp(/\${(.+?)}/g),a=e.match(s);if(!a)return n.R("短信内容中没有变量，请重新输入！"),void(n.fileName="");if(!t[0].hasOwnProperty("手机号码"))return n.R("上传文件内容格式不正确，请参考模板重新上传文件！"),void(n.fileName="");for(var i=0;i<a.length;i++){var o=a[i].replace("${","").replace("}","");if(!t[0].hasOwnProperty(o))return n.R("上传文件内容格式不正确，请参考模板重新上传文件！"),void(n.fileName="")}function l(t){var e=t.match(/^(\d+)-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})$/);if(null==e)return!1;e[2]=e[2]-1;var n=new Date(e[1],e[2],e[3],e[4],e[5],e[6]);return n.getFullYear()==e[1]&&(n.getMonth()==e[2]&&(n.getDate()==e[3]&&(n.getHours()==e[4]&&(n.getMinutes()==e[5]&&n.getSeconds()==e[6]))))}for(var r=[],c=[],u=[],p=0;p<t.length;p++){var d=Object(m.o)(t[p]["手机号码"]),v=Object(m.o)(t[p]["发送时间"]);if(l(v)||(v=n.formatDateB(v)),Object(m.l)(d)&&l(v)){t[p]["发送时间"]=v,c.push(t[p]);for(var g=e,f=!1,h=0;h<a.length;h++){var _=a[h].replace("${","").replace("}",""),C=t[p][_];if(""===C||null===C){f=!1;break}f=!0,g=g.replace("${"+_+"}",C)}var b={phone:d,sentTime:v,content:"【"+n.smsContent.signature+"】"+g};f&&p<100&&r.push(b)}else u.push(t[p])}var w=Object(m.r)(c);n.fileJson=w,n.fileErrJson=u,n.previewLists=Object(m.r)(r),n.$nextTick(function(){n.R("导入数据共"+t.length+"条，去重过滤后有效数据共"+w.length+"条")})},useTpl:function(t){this.smsContent.content=t.tplContent,this.smsId=t.id,this.dialogTpl=!1},downloadXlsx:function(){var t={phone:"手机号码",time:"发送时间",var0:"变量1",var1:"变量2"},e=[{phone:"177****0000",time:"2019-12-12 12:00:00",var0:"1",var1:"2"}],n=this.smsContent.content;if(n){var s=n.match(/\${(.+?)}/g),a=s.length;t={phone:"手机号码",time:"发送时间"};for(var i={phone:"177****0000",time:"2019-12-12 12:00:00"},o=0;o<a;o++)t["var"+o]=s[o].replace("${","").replace("}",""),i["var"+o]=o+1;e[0]=i}var r=Object(l.c)({sheetName:t,datas:e});Object(l.b)(r)},addVar:function(){var t=this;t.smsContent.content=t.smsContent.content+"${变量"+t.num+"}",t.num=t.num+1},inputWitdh:function(){var t=o()(".sms-content p").width();o()(".sms-content input").width(t+2);var e=t+40;e=e>68?e:68,o()(".sms-content textarea").css({"text-indent":e})},smsCount:function(){var t=this.smsContent.signature.length+this.smsContent.content.length+2;this.totalLength=t;var e=0;e=t<=70?1:Math.ceil(t/67),this.smsLength=e},reset:function(){this.previewLists="",this.fileName="",this.fileJson="",this.fileErrJson=""}},watch:{"smsContent.signature":function(){var t=this;t.$nextTick(function(){t.inputWitdh(),t.smsCount()})},"smsContent.content":function(t,e){var n=this,s=t.match(/^【(.+?)】/g);if(s&&1===s.length&&s[0].length<25){var a=t.replace(s[0],"");n.smsContent.signature=s[0].replace("【","").replace("】",""),n.smsContent.content=a}var i=new RegExp(/\${(.+?)}/g),o=t.match(i);Object(m.m)(o)&&(n.R("变量名称不能重复!"),n.smsContent.content=e),n.$nextTick(function(){n.inputWitdh(),n.smsCount()})},customSentType:function(){this.reset(),this.smsContent.signature="",this.smsContent.content="",this.smsId=""}},beforeRouteLeave:function(t,e,n){window.onbeforeunload=null,n()}},p={render:function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"custom-group"},[n("el-row",{attrs:{gutter:20}},[n("el-col",{attrs:{span:14}},[n("div",{staticClass:"grid-content"},[n("div",{staticClass:"content-sent"},[n("el-card",{staticClass:"box-card"},[n("div",{staticClass:"c",attrs:{slot:"header"},slot:"header"},[n("span",[n("b",[n("span",{staticClass:"error"},[t._v("*")]),t._v("短信内容")])]),t._v(" "),n("a",{staticClass:"fr",on:{click:function(e){t.dialogTpl=!0}}},[t._v("选择模板")])]),t._v(" "),n("div",{staticClass:"item-1"},[n("div",{staticClass:"alert"},[n("i",{staticClass:"el-icon-warning color"}),t._v(" "),n("p",[t._v("\n                  1、个性化短信需包含签名，签名通常为公司名称简称或品牌名称；"),n("br"),t._v("\n                  2、个性化短信通常包含变量，变量请用 ${变量名称} 占位；"),n("br"),t._v("\n                  3、提交下发前，需导入含有变量值的号码文件;"),n("br"),t._v("\n                  4、变量名称不能重复；"),n("br"),t._v("\n                  5、上传文件数据不要超过 100,000 条。\n                ")])]),t._v(" "),n("div",{staticClass:"sms-content mt2 p1"},[n("p",[t._v(t._s(t.smsContent.signature||"短信签名，如：中国移动"))]),t._v(" "),n("div",{staticClass:"input"},[n("span",[t._v("【")]),t._v(" "),n("input",{directives:[{name:"model",rawName:"v-model.trim",value:t.smsContent.signature,expression:"smsContent.signature",modifiers:{trim:!0}}],attrs:{type:"text",maxlength:"24",placeholder:"短信签名，如：中国移动"},domProps:{value:t.smsContent.signature},on:{input:function(e){e.target.composing||t.$set(t.smsContent,"signature",e.target.value.trim())},blur:function(e){return t.$forceUpdate()}}}),t._v(" "),n("span",[t._v("】")])]),t._v(" "),n("textarea",{directives:[{name:"model",rawName:"v-model.trim",value:t.smsContent.content,expression:"smsContent.content",modifiers:{trim:!0}}],attrs:{rows:"8",placeholder:"短信内容，如：尊敬的${姓名}你好，您本月消费金额为:${金额}元，请注意查收账单！"},domProps:{value:t.smsContent.content},on:{input:function(e){e.target.composing||t.$set(t.smsContent,"content",e.target.value.trim())},blur:function(e){return t.$forceUpdate()}}}),t._v(" "),n("div",{staticClass:"t-r",staticStyle:{"margin-top":"10px"}},[n("span",{staticClass:"cp color",on:{click:function(e){return t.addVar()}}},[n("img",{staticStyle:{"vertical-align":"middle","margin-top":"-3px"},attrs:{src:"/static/client/img/sms/7.png"}}),t._v(" 添加变量\n                  ")])])]),t._v(" "),n("div",{staticClass:"recipient-tip t-r"},[t._v("\n                总计 "+t._s(t.totalLength)+" 个字，共分 "+t._s(t.smsLength)+" 条。\n              ")])])]),t._v(" "),n("div",{staticClass:"download-exl mt2 bgw"},[n("span",[n("b",[t._v("模版文件：")])]),t._v(" "),n("span",{staticClass:"info"},[t._v("导入格式参考模板")]),t._v(" "),n("span",{staticClass:"color cp",on:{click:t.downloadXlsx}},[t._v("模板下载")])]),t._v(" "),n("el-card",{staticClass:"box-card mt2"},[n("div",{staticClass:"c",attrs:{slot:"header"},slot:"header"},[n("span",[n("b",[n("span",{staticClass:"error"},[t._v("*")]),t._v("导入模版文件")])])]),t._v(" "),n("div",[n("label",{staticClass:"el-button el-button--primary"},[n("span",[n("input",{staticClass:"hide",attrs:{type:"file",id:"file",accept:".xls,.xlsx"},on:{change:function(e){return t.importFile(1)}}}),t._v("\n                  上传文件\n                  "),n("i",{staticClass:"el-icon-upload el-icon--right"})])]),t._v(" "),n("span",[t._v(t._s(t.fileName))])])])],1),t._v(" "),t.previewLists.length>0?n("el-card",{staticClass:"box-card mt2"},[n("div",{staticClass:"c",attrs:{slot:"header"},slot:"header"},[n("span",[n("b",[t._v("短信预览")])])]),t._v(" "),n("div",{staticClass:"custom-preview"},[n("el-table",{attrs:{data:t.previewLists,"max-height":"250"}},[n("el-table-column",{attrs:{type:"index",label:"序号",width:"50"}}),t._v(" "),n("el-table-column",{attrs:{prop:"phone",label:"手机号码","min-width":"120px"}}),t._v(" "),n("el-table-column",{attrs:{prop:"sentTime",label:"发送时间","min-width":"160px"}}),t._v(" "),n("el-table-column",{attrs:{prop:"content",label:"短信内容","min-width":"270px","show-overflow-tooltip":!0}})],1)],1)]):t._e(),t._v(" "),n("div",{staticClass:"sent-btn t-c p2 mt2"},[n("el-button",{attrs:{type:"primary"},on:{click:function(e){return t.sent()}}},[t._v("提交发送")])],1)],1)]),t._v(" "),n("el-col",{attrs:{span:10}},[n("div",{staticClass:"grid-content"},[n("el-card",{staticClass:"box-card"},[n("div",{staticClass:"c",attrs:{slot:"header"},slot:"header"},[n("span",[n("b",[t._v("教程")])])]),t._v(" "),n("div",[n("img",{attrs:{src:"/static/client/img/custom/3.png"}})])])],1)])],1),t._v(" "),n("transition",{attrs:{name:"dialog-fade"}},[t.dialogTpl?n("div",{staticClass:"dialog access"},[n("div",{staticClass:"dialog-body"},[n("div",{staticClass:"dialog-header"},[t._v("\n          选择模板 "),n("i",{staticClass:"fr iconfont iconsystem-cancel-bold",on:{click:function(e){t.dialogTpl=!1}}})]),t._v(" "),n("div",{staticClass:"dialog-content c p2"},[t.dialogTpl?n("div",[n("select-tpl",{on:{useTpl:t.useTpl}})],1):t._e()]),t._v(" "),n("div",{staticClass:"dialog-footer c p2"},[n("div",{staticClass:"fr"},[n("el-button",{on:{click:function(e){t.dialogTpl=!1}}},[t._v("取消")])],1)])])]):t._e()])],1)},staticRenderFns:[]},d=n("VU/8")(u,p,!1,null,null,null);e.default=d.exports}});